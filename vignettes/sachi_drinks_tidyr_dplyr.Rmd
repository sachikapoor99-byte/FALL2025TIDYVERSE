---
title: "Tidyverse Vignette: Wrangling & Visualizing FiveThirtyEight 'drinks' data"
author: "Sachi Kapoor"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    number_sections: true
---

```{r}
# ---- Setup ----

pkgs <- c("tidyverse","fivethirtyeight","janitor","scales","forcats")
for (p in pkgs) if (!requireNamespace(p, quietly = TRUE)) install.packages(p)
lapply(pkgs, library, character.only = TRUE)
theme_set(theme_minimal(base_size = 12))
```

```{r}
# ---- Load & inspect ----

data("drinks", package = "fivethirtyeight")
drinks <- janitor::clean_names(drinks)
glimpse(drinks)
```

```{r}
# ---- Pivot to long format ----

drinks_long <- drinks |>
tidyr::pivot_longer(
cols = dplyr::ends_with("_servings"),
names_to = "beverage",
values_to = "servings"
) |>
dplyr::mutate(
beverage = stringr::str_replace(beverage, "_servings$", "") |> stringr::str_to_title()
)

dplyr::slice_head(drinks_long, n = 8)
```

```{r}
# ---- Rank countries by average servings ----

top15 <- drinks_long |>
dplyr::group_by(country) |>
dplyr::summarise(avg_servings = mean(servings, na.rm = TRUE)) |>
dplyr::arrange(dplyr::desc(avg_servings)) |>
dplyr::slice_head(n = 15)

top15
```

```{r}
# ---- Plot: stacked bars by beverage ----

top15_comp <- drinks_long |>
dplyr::semi_join(top15, by = "country") |>
dplyr::mutate(country = forcats::fct_reorder(country, servings, .fun = mean, .desc = TRUE))

ggplot2::ggplot(top15_comp, ggplot2::aes(x = country, y = servings, fill = beverage)) +
ggplot2::geom_col() +
ggplot2::coord_flip() +
ggplot2::scale_y_continuous(labels = scales::label_number(accuracy = 1)) +
ggplot2::scale_fill_brewer(palette = "Set2") +
ggplot2::labs(
title = "Alcohol servings by beverage (Top 15 countries by average servings)",
x = NULL, y = "Servings per person", fill = "Beverage"
)
```

```{r}
# ---- Quick correlation (optional) ----

summary_tbl <- drinks |>
dplyr::mutate(avg_servings = rowMeans(dplyr::across(dplyr::ends_with("_servings")), na.rm = TRUE)) |>
dplyr::summarise(
n = dplyr::n(),
cor_avg_total = cor(avg_servings, total_litres_of_pure_alcohol, use = "complete.obs")
)

summary_tbl
```

```{r}
# ---- Session info (for reproducibility) ----

sessionInfo()
```
cat("**Data citation:** FiveThirtyEight data via the `fivethirtyeight` R package (see [https://cran.r-project.org/package=fivethirtyeight](https://cran.r-project.org/package=fivethirtyeight)).")
####  This part is updated by Mehreen Ali Gillani

```{r}
# ---- EXTENSION 1: Create beverage preference analysis  ----

# Calculate which beverage is most dominant in each country
beverage_preference <- drinks_long |>
  dplyr::group_by(country) |>
  dplyr::mutate(
    total_servings = sum(servings, na.rm = TRUE),
    pct_of_total = servings / total_servings * 100
  ) |>
  dplyr::slice_max(pct_of_total, n = 1, with_ties = FALSE) |>
  dplyr::rename(dominant_beverage = beverage, dominant_pct = pct_of_total) |>
  dplyr::select(country, dominant_beverage, dominant_pct, total_servings)

# Show countries where one beverage dominates (>70% of servings)
beverage_dominance <- beverage_preference |>
  dplyr::filter(dominant_pct > 70) |>
  dplyr::arrange(dplyr::desc(dominant_pct))

cat("Countries where one beverage type dominates (>70% of servings):\n")
print(beverage_dominance, n = 10)

```

```{r}
# ---- EXTENSION 2: Enhanced visualization - faceted by beverage type----

# Create a faceted plot to compare beverage distributions across top countries
top10_by_beverage <- drinks_long |>
  dplyr::group_by(beverage) |>
  dplyr::slice_max(servings, n = 7) |>
  dplyr::ungroup()

ggplot2::ggplot(top10_by_beverage, 
                ggplot2::aes(x = forcats::fct_reorder(country, servings), 
                             y = servings)) +
  ggplot2::geom_col(fill = "steelblue", alpha = 1.0) +
  ggplot2::facet_wrap(~beverage, scales = "free_y", ncol = 1) +
  ggplot2::coord_flip() +
  ggplot2::scale_y_continuous(labels = scales::label_number()) +
  ggplot2::labs(
    title = "Top 7 Countries by Servings for Each Beverage Type",
    subtitle = "Showing beer, spirit, and wine consumption patterns separately",
    x = NULL,
    y = "Servings per person"
  ) +
  ggplot2::theme(
    strip.text = ggplot2::element_text(face = "bold", size = 8),
    panel.spacing = ggplot2::unit(1, "lines")
  )

```

